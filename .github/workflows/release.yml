name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-release:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load version file
        id: version
        run: |
          set -euo pipefail
          source VERSION
          echo "marketing=${MARKETING_VERSION}" >> "$GITHUB_OUTPUT"
          echo "build=${BUILD_NUMBER}" >> "$GITHUB_OUTPUT"

          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            expected="v${MARKETING_VERSION}"
            if [ "${GITHUB_REF_NAME}" != "$expected" ]; then
              echo "Tag ${GITHUB_REF_NAME} does not match MARKETING_VERSION ${MARKETING_VERSION}" >&2
              exit 1
            fi
          fi

      - name: Build unsigned DMG
        run: ./scripts/build.sh unsigned

      - name: Upload DMG to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.dmg
          generate_release_notes: true
          tag_name: v${{ steps.version.outputs.marketing }}
